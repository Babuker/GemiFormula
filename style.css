const apiData = {
    "Paracetamol": { dose: 500, density: 0.6, moisture: false, cost: 15, class: "مسكن" },
    "Metronidazole": { dose: 500, density: 0.5, moisture: true, cost: 40, class: "مضاد حيوي" },
    "Diclofenac": { dose: 50, density: 0.7, moisture: true, cost: 85, class: "مضاد التهاب" },
    "Ibuprofen": { dose: 200, density: 0.5, moisture: false, cost: 25, class: "مسكن" }
};

let chart = null;

function runOptimizer() {
    const apiName = document.getElementById('apiSelect').value;
    const strategy = document.getElementById('strategy').value;
    const batchSize = parseInt(document.getElementById('batchSize').value);
    const api = apiData[apiName];

    // 1. حساب الوزن التلقائي للأقراص
    let unitWeight = api.dose < 100 ? 150 : Math.ceil((api.dose * 1.3) / 10) * 10;
    
    // 2. منطق الاستراتيجية وتوزيع المواد
    let excipientMass = unitWeight - api.dose;
    let filler, binder, other;
    
    if (strategy === 'cost') {
        filler = excipientMass * 0.85; binder = excipientMass * 0.10; other = excipientMass * 0.05;
    } else if (strategy === 'quality') {
        filler = excipientMass * 0.60; binder = excipientMass * 0.25; other = excipientMass * 0.15;
    } else {
        filler = excipientMass * 0.75; binder = excipientMass * 0.15; other = excipientMass * 0.10;
    }

    // 3. الحسابات اللوجستية والمساحة
    const totalMassKg = (unitWeight * batchSize) / 1000000;
    const volM3 = (totalMassKg / (api.density * 1000)).toFixed(4);
    const floorArea = (volM3 * 2.5).toFixed(2); // مساحة التخزين مع الممرات
    const estCost = (totalMassKg * api.cost).toFixed(2);
    const boxes = Math.ceil(batchSize / 30); // 30 قرص في الصندوق

    // 4. تحديث الواجهة
    document.getElementById('resultsArea').style.display = 'block';
    updateTable(unitWeight, totalMassKg, volM3, floorArea, estCost, boxes);
    updateChart(api.dose, filler, binder, other);
    updateRecs(api, strategy, boxes);
}

function updateTable(w, mass, vol, area, cost, boxes) {
    document.getElementById('logisticsBody').innerHTML = `
        <tr><td><b>الوزن المثالي للوحدة:</b></td><td>${w} ملجم</td></tr>
        <tr><td><b>إجمالي كتلة التشغيلة:</b></td><td>${mass.toFixed(2)} كجم</td></tr>
        <tr><td><b>الحجم المطلوب (m³):</b></td><td>${vol} متر مكعب</td></tr>
        <tr><td><b>مساحة المستودع المطلوبة:</b></td><td>${area} متر مربع</td></tr>
        <tr><td><b>التكلفة التقديرية (مواد):</b></td><td>$${cost}</td></tr>
        <tr><td><b>إجمالي الصناديق (30 قرص):</b></td><td>${boxes} صندوق</td></tr>
    `;
}

function updateRecs(api, strategy, boxes) {
    const list = document.getElementById('recList');
    let items = [
        `<b>طريقة التصنيع:</b> ${api.dose >= 500 ? "التحبيب الرطب (Wet Granulation)" : "الكبس المباشر (Direct Compression)"}`,
        `<b>ظروف التخزين:</b> درجة حرارة < 25°م ${api.moisture ? "مع رطوبة < 60%" : ""}`,
        `<b>التعبئة الأفضل:</b> ${api.moisture ? "Alu-Alu (حماية قصوى)" : "PVC/PVDC (اقتصادي)"}`,
        `<b>نصيحة الصناديق:</b> يتم تعبئة ${boxes} صندوق، يفضل ترتيبها على منصات خشبية (Pallets).`
    ];
    list.innerHTML = items.map(i => `<li>${i}</li>`).join('');
}

function updateChart(a, f, b, o) {
    const ctx = document.getElementById('formulaChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['المادة الفعالة', 'مواد مالئة', 'مواد رابطة', 'إضافات أخرى'],
            datasets: [{
                data: [a, f, b, o],
                backgroundColor: ['#1a5276', '#3498db', '#f1c40f', '#e74c3c']
            }]
        },
        options: { plugins: { legend: { position: 'bottom', rtl: true } } }
    });
}

function downloadPDFReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("PharmaForm PRO Optimization Report", 105, 20, null, null, "center");
    doc.autoTable({
        startY: 30,
        head: [['Metric', 'Value']],
        body: Array.from(document.querySelectorAll('#logisticsTable tr')).map(tr => [tr.cells[0].innerText, tr.cells[1].innerText]),
    });
    doc.save("Report.pdf");
}
